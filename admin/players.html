<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Management</title>
    <style>
        /* [Keep all your original styles here] */
        /* ... (Your existing CSS styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- [Keep all your original HTML structure here] -->
        <!-- ... (Your existing HTML content) ... -->
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // ========================
        // Enhanced Firebase Setup
        // ========================
        const firebaseConfig = {
            apiKey: "AIzaSyBP1Cx8cmvjf24oY1gNiD_-qxis6v6pwNI",
            authDomain: "taprace-63f8e.firebaseapp.com",
            databaseURL: "https://taprace-63f8e-default-rtdb.firebaseio.com",
            projectId: "taprace-63f8e",
            storageBucket: "taprace-63f8e.appspot.com",
            messagingSenderId: "93332718324",
            appId: "1:93332718324:web:4b48350c0b64061eb794a1"
        };

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
        const db = firebase.database();

        // ========================
        // Enhanced Player Loading
        // ========================
        let allPlayers = [];

        function loadPlayers() {
            console.log("[DEBUG] Starting player load...");
            
            const loadingRow = '<tr><td colspan="9">üîÉ Loading players...</td></tr>';
            document.getElementById('player-list').innerHTML = loadingRow;

            db.ref("players").on("value", 
                (snapshot) => { // Success callback
                    console.log("[DEBUG] Firebase data received:", snapshot.val());
                    
                    if (!snapshot.exists()) {
                        console.warn("[DEBUG] No data found in 'players' node");
                        document.getElementById('player-list').innerHTML = 
                            '<tr><td colspan="9">‚ùå No players found in database</td></tr>';
                        return;
                    }

                    allPlayers = [];
                    snapshot.forEach((child) => {
                        const player = child.val();
                        allPlayers.push({
                            id: child.key,
                            name: player.name || 'Anonymous',
                            email: player.email || 'N/A',
                            totalClicks: player.totalClicks || 0,
                            rank: player.rank || 0,
                            walletBalance: player.walletBalance || 0,
                            registrationDate: player.registrationDate || 'Unknown',
                            banned: player.banned || false
                        });
                    });

                    console.log(`[DEBUG] Processed ${allPlayers.length} players`);
                    filterPlayers();
                },
                (error) => { // Error callback
                    console.error("[ERROR] Firebase read failed:", error);
                    document.getElementById('player-list').innerHTML = 
                        `<tr><td colspan="9">‚ö†Ô∏è Error: ${error.message}</td></tr>`;
                }
            );
        }

        // ========================
        // Enhanced Rendering
        // ========================
        function renderPlayers(players) {
            const tbody = document.getElementById("player-list");
            
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">üîé No matching players found</td></tr>';
                return;
            }

            tbody.innerHTML = players.map(player => `
                <tr>
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${player.email}</td>
                    <td>${player.totalClicks}</td>
                    <td>${player.rank}</td>
                    <td>${player.walletBalance.toFixed(3)} ETH</td>
                    <td>${player.registrationDate}</td>
                    <td>${player.banned ? '‚ùå Banned' : '‚úÖ Active'}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="openEditModal('${player.id}')">Edit</button>
                        <button class="ban-btn" onclick="toggleBan('${player.id}', ${player.banned})">
                            ${player.banned ? 'Unban' : 'Ban'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ========================
        // Enhanced Error Handling
        // ========================
        async function openEditModal(playerId) {
            try {
                const snapshot = await db.ref(`players/${playerId}`).once('value');
                if (!snapshot.exists()) {
                    alert("Player not found!");
                    return;
                }
                
                const player = snapshot.val();
                document.getElementById('editId').value = playerId;
                document.getElementById('editName').value = player.name;
                document.getElementById('editEmail').value = player.email;
                document.getElementById('editBalance').value = player.walletBalance;
                document.getElementById('editRank').value = player.rank;
                openModal('editModal');
            } catch (error) {
                console.error("Edit modal error:", error);
                alert("Failed to load player data!");
            }
        }

        // [Keep the rest of your original functions]
        // ... (filterPlayers, toggleBan, modal functions, etc) ...

        // ========================
        // Initialization
        // ========================
        document.addEventListener("DOMContentLoaded", () => {
            console.log("[DEBUG] DOM loaded");
            loadPlayers();
            document.getElementById('searchInput').addEventListener('input', filterPlayers);
            document.getElementById('filterSelect').addEventListener('change', filterPlayers);
        });
    </script>
</body>
</html>
